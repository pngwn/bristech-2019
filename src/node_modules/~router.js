// prettier-ignore
export function router(routes) {
	const routesArray = Object.entries(routes);
	const fallback = routesArray.find(([p]) => p === "*");

	async function route(url) {
		const _url = url.state || url;
		const current = routesArray.find(
			([p]) => p !== '*' && new RegExp("^" + p + "$").test(_url)
		);

		if (current) {
			current[1]();
		} else if(fallback) {
			fallback[1]();
		}

		!url.state && history.pushState(url, null, url);
	}

  const url = window.location.href.replace(/.+\//, '/');
	route(url);

	function click(e) {
		// thanks luke
		const x = e.target.closest('a'),
			y = x && x.getAttribute('href');

		if (
			e.ctrlKey ||
			e.metaKey ||
			e.altKey ||
			e.shiftKey ||
			e.button ||
			e.defaultPrevented
		)
			return;

		if (!y || x.target || x.host !== location.host) return;

		e.preventDefault();
		route(y);
	}

	addEventListener('popstate', route);
	addEventListener('pushstate', route);
	addEventListener('click', click);

	return () => {
		removeEventListener('popstate', route);
		removeEventListener('pushstate', route);
		removeEventListener('click', click);
	};
}
