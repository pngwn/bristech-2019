// prettier-ignore
import { writable } from 'svelte/store'

export function router(routes) {
	const { set, subscribe } = writable();
	const fallback = routes.findIndex(([p]) => p === "*");
	let current;

	async function route(url) {
		const _url = url.state || url;
		current = routes.findIndex(
			([p]) => p !== "*" && new RegExp("^" + p + "$").test(_url),
		);

		if (current !== -1) {
			set(routes[current][1]);
		} else if (fallback) {
			set(routes[fallback][1]);
		}

		!url.state && history.pushState(url, null, url);
	}

	const url = window.location.href.replace(/.+\//, "/");
	route(url);

	function click(e) {
		// thanks luke
		const x = e.target.closest("a"),
			y = x && x.getAttribute("href");

		if (
			e.ctrlKey ||
			e.metaKey ||
			e.altKey ||
			e.shiftKey ||
			e.button ||
			e.defaultPrevented
		)
			return;

		if (!y || x.target || x.host !== location.host) return;

		e.preventDefault();
		route(y);
	}

	addEventListener("popstate", route);
	addEventListener("pushstate", route);
	addEventListener("click", click);

	return {
		current: () => current,
		route,
		component: { subscribe },
		destroy: () => {
			removeEventListener("popstate", route);
			removeEventListener("pushstate", route);
			removeEventListener("click", click);
		},
	};
}
